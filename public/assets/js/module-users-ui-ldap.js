/*
 * MikoPBX - free phone system for small business
 * Copyright © 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright © 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, globalTranslate, Form, PbxApi*/
var moduleUsersUILdap = {
  /**
   * Checkbox for LDAP authentication.
   * @type {jQuery}
   * @private
   */
  $useLdapCheckbox: $('#use-ldap-auth-method'),

  /**
   * Set of form fields to use for LDAP authentication.
   * @type {jQuery}
   * @private
   */
  $formFieldsForLdapSettings: $('.disable-if-no-ldap'),

  /**
   * Set of elements of the form adhered to ldap auth method.
   * @type {jQuery}
   * @private
   */
  $formElementsAvailableIfLdapIsOn: $('.show-only-if-ldap-enabled'),

  /**
   * jQuery object for the ldap check segment.
   * @type {jQuery}
   */
  $ldapCheckSegment: $('#ldap-check-auth'),

  /**
   * jQuery object for the form.
   * @type {jQuery}
   */
  $formObj: $('#module-users-ui-ldap-form'),

  /**
   * jQuery object for the check credentials button.
   * @type {jQuery}
   */
  $checkAuthButton: $('.check-ldap-credentials.button'),

  /**
   * Validation rules for the form fields.
   * @type {Object}
   */
  validateRules: {
    serverName: {
      identifier: 'serverName',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.module_usersui_ValidateServerNameIsEmpty
      }]
    },
    serverPort: {
      identifier: 'serverPort',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.module_usersui_ValidateServerPortIsEmpty
      }]
    },
    administrativeLogin: {
      identifier: 'administrativeLogin',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.module_usersui_ValidateAdministrativeLoginIsEmpty
      }]
    },
    administrativePasswordHidden: {
      identifier: 'administrativePasswordHidden',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.module_usersui_ValidateAdministrativePasswordIsEmpty
      }]
    },
    baseDN: {
      identifier: 'baseDN',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.module_usersui_ValidateBaseDNIsEmpty
      }]
    },
    userIdAttribute: {
      identifier: 'userIdAttribute',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.module_usersui_ValidateUserIdAttributeIsEmpty
      }]
    }
  },

  /**
   * Initializes the module.
   */
  initialize: function initialize() {
    moduleUsersUILdap.initializeForm(); // Handle check button click

    moduleUsersUILdap.$checkAuthButton.api({
      url: "".concat(globalRootUrl, "module-users-u-i/ldap-config/check-auth"),
      method: 'POST',
      beforeSend: function beforeSend(settings) {
        $(this).addClass('loading disabled');
        settings.data = moduleUsersUILdap.$formObj.form('get values');
        return settings;
      },
      successTest: function successTest(response) {
        return response.success;
      },

      /**
       * Handles the successful response of the 'check-ldap-auth' API request.
       * @param {object} response - The response object.
       */
      onSuccess: function onSuccess(response) {
        $(this).removeClass('loading disabled');
        $('.ui.message.ajax').remove();
        moduleUsersUILdap.$ldapCheckSegment.after("<div class=\"ui icon message ajax positive\"><i class=\"icon check\"></i> ".concat(response.message, "</div>"));
      },

      /**
       * Handles the failure response of the 'check-ldap-auth' API request.
       * @param {object} response - The response object.
       */
      onFailure: function onFailure(response) {
        $(this).removeClass('loading disabled');
        $('.ui.message.ajax').remove();
        moduleUsersUILdap.$ldapCheckSegment.after("<div class=\"ui icon message ajax negative\"><i class=\"icon exclamation circle\"></i>".concat(response.message, "</div>"));
      }
    }); // General ldap switcher

    moduleUsersUILdap.$useLdapCheckbox.checkbox({
      onChange: moduleUsersUILdap.onChangeLdapCheckbox
    });
    moduleUsersUILdap.onChangeLdapCheckbox();
  },

  /**
   * Handles the change of the LDAP checkbox.
   */
  onChangeLdapCheckbox: function onChangeLdapCheckbox() {
    if (moduleUsersUILdap.$useLdapCheckbox.checkbox('is checked')) {
      moduleUsersUILdap.$formFieldsForLdapSettings.removeClass('disabled');
      moduleUsersUILdap.$formElementsAvailableIfLdapIsOn.show();
    } else {
      moduleUsersUILdap.$formFieldsForLdapSettings.addClass('disabled');
      moduleUsersUILdap.$formElementsAvailableIfLdapIsOn.hide();
    }
  },

  /**
   * Callback function before sending the form.
   * @param {object} settings - The settings object.
   * @returns {object} - The modified settings object.
   */
  cbBeforeSendForm: function cbBeforeSendForm(settings) {
    var result = settings;
    result.data = moduleUsersUILdap.$formObj.form('get values');

    if (moduleUsersUILdap.$useLdapCheckbox.checkbox('is checked')) {
      result.data.useLdapAuthMethod = '1';
    } else {
      result.data.useLdapAuthMethod = '0';
    }

    return result;
  },

  /**
   * Callback function after sending the form.
   */
  cbAfterSendForm: function cbAfterSendForm() {// Callback implementation
  },

  /**
   * Initializes the form.
   */
  initializeForm: function initializeForm() {
    Form.$formObj = moduleUsersUILdap.$formObj;
    Form.url = "".concat(globalRootUrl, "module-users-u-i/ldap-config/save");
    Form.validateRules = moduleUsersUILdap.validateRules;
    Form.cbBeforeSendForm = moduleUsersUILdap.cbBeforeSendForm;
    Form.cbAfterSendForm = moduleUsersUILdap.cbAfterSendForm;
    Form.initialize();
  }
};
$(document).ready(function () {
  moduleUsersUILdap.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUtdXNlcnMtdWktbGRhcC5qcyJdLCJuYW1lcyI6WyJtb2R1bGVVc2Vyc1VJTGRhcCIsIiR1c2VMZGFwQ2hlY2tib3giLCIkIiwiJGZvcm1GaWVsZHNGb3JMZGFwU2V0dGluZ3MiLCIkZm9ybUVsZW1lbnRzQXZhaWxhYmxlSWZMZGFwSXNPbiIsIiRsZGFwQ2hlY2tTZWdtZW50IiwiJGZvcm1PYmoiLCIkY2hlY2tBdXRoQnV0dG9uIiwidmFsaWRhdGVSdWxlcyIsInNlcnZlck5hbWUiLCJpZGVudGlmaWVyIiwicnVsZXMiLCJ0eXBlIiwicHJvbXB0IiwiZ2xvYmFsVHJhbnNsYXRlIiwibW9kdWxlX3VzZXJzdWlfVmFsaWRhdGVTZXJ2ZXJOYW1lSXNFbXB0eSIsInNlcnZlclBvcnQiLCJtb2R1bGVfdXNlcnN1aV9WYWxpZGF0ZVNlcnZlclBvcnRJc0VtcHR5IiwiYWRtaW5pc3RyYXRpdmVMb2dpbiIsIm1vZHVsZV91c2Vyc3VpX1ZhbGlkYXRlQWRtaW5pc3RyYXRpdmVMb2dpbklzRW1wdHkiLCJhZG1pbmlzdHJhdGl2ZVBhc3N3b3JkSGlkZGVuIiwibW9kdWxlX3VzZXJzdWlfVmFsaWRhdGVBZG1pbmlzdHJhdGl2ZVBhc3N3b3JkSXNFbXB0eSIsImJhc2VETiIsIm1vZHVsZV91c2Vyc3VpX1ZhbGlkYXRlQmFzZUROSXNFbXB0eSIsInVzZXJJZEF0dHJpYnV0ZSIsIm1vZHVsZV91c2Vyc3VpX1ZhbGlkYXRlVXNlcklkQXR0cmlidXRlSXNFbXB0eSIsImluaXRpYWxpemUiLCJpbml0aWFsaXplRm9ybSIsImFwaSIsInVybCIsImdsb2JhbFJvb3RVcmwiLCJtZXRob2QiLCJiZWZvcmVTZW5kIiwic2V0dGluZ3MiLCJhZGRDbGFzcyIsImRhdGEiLCJmb3JtIiwic3VjY2Vzc1Rlc3QiLCJyZXNwb25zZSIsInN1Y2Nlc3MiLCJvblN1Y2Nlc3MiLCJyZW1vdmVDbGFzcyIsInJlbW92ZSIsImFmdGVyIiwibWVzc2FnZSIsIm9uRmFpbHVyZSIsImNoZWNrYm94Iiwib25DaGFuZ2UiLCJvbkNoYW5nZUxkYXBDaGVja2JveCIsInNob3ciLCJoaWRlIiwiY2JCZWZvcmVTZW5kRm9ybSIsInJlc3VsdCIsInVzZUxkYXBBdXRoTWV0aG9kIiwiY2JBZnRlclNlbmRGb3JtIiwiRm9ybSIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUdBLElBQU1BLGlCQUFpQixHQUFHO0FBRXRCO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsZ0JBQWdCLEVBQUVDLENBQUMsQ0FBQyx1QkFBRCxDQVBHOztBQVN0QjtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLDBCQUEwQixFQUFFRCxDQUFDLENBQUMscUJBQUQsQ0FkUDs7QUFnQnRCO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUUsRUFBQUEsZ0NBQWdDLEVBQUVGLENBQUMsQ0FBQyw0QkFBRCxDQXJCYjs7QUF1QnRCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lHLEVBQUFBLGlCQUFpQixFQUFFSCxDQUFDLENBQUMsa0JBQUQsQ0EzQkU7O0FBNkJ0QjtBQUNKO0FBQ0E7QUFDQTtBQUNJSSxFQUFBQSxRQUFRLEVBQUVKLENBQUMsQ0FBQyw0QkFBRCxDQWpDVzs7QUFtQ3RCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lLLEVBQUFBLGdCQUFnQixFQUFFTCxDQUFDLENBQUMsZ0NBQUQsQ0F2Q0c7O0FBeUN0QjtBQUNKO0FBQ0E7QUFDQTtBQUNJTSxFQUFBQSxhQUFhLEVBQUU7QUFDWEMsSUFBQUEsVUFBVSxFQUFFO0FBQ1JDLE1BQUFBLFVBQVUsRUFBRSxZQURKO0FBRVJDLE1BQUFBLEtBQUssRUFBRSxDQUNIO0FBQ0lDLFFBQUFBLElBQUksRUFBRSxPQURWO0FBRUlDLFFBQUFBLE1BQU0sRUFBRUMsZUFBZSxDQUFDQztBQUY1QixPQURHO0FBRkMs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LElBQVAsQ0FBWWtCLGlCQUFaLEdBQWdDLEdBQWhDO0FBQ0g7O0FBRUQsV0FBT0QsTUFBUDtBQUNILEdBaExxQjs7QUFrTHRCO0FBQ0o7QUFDQTtBQUNJRSxFQUFBQSxlQXJMc0IsNkJBcUxKLENBQ2Q7QUFDSCxHQXZMcUI7O0FBeUx0QjtBQUNKO0FBQ0E7QUFDSTNCLEVBQUFBLGNBNUxzQiw0QkE0TEw7QUFDYjRCLElBQUFBLElBQUksQ0FBQ2pELFFBQUwsR0FBZ0JOLGlCQUFpQixDQUFDTSxRQUFsQztBQUNBaUQsSUFBQUEsSUFBSSxDQUFDMUIsR0FBTCxhQUFjQyxhQUFkO0FBQ0F5QixJQUFBQSxJQUFJLENBQUMvQyxhQUFMLEdBQXFCUixpQkFBaUIsQ0FBQ1EsYUFBdkM7QUFDQStDLElBQUFBLElBQUksQ0FBQ0osZ0JBQUwsR0FBd0JuRCxpQkFBaUIsQ0FBQ21ELGdCQUExQztBQUNBSSxJQUFBQSxJQUFJLENBQUNELGVBQUwsR0FBdUJ0RCxpQkFBaUIsQ0FBQ3NELGVBQXpDO0FBQ0FDLElBQUFBLElBQUksQ0FBQzdCLFVBQUw7QUFDSDtBQW5NcUIsQ0FBMUI7QUFzTUF4QixDQUFDLENBQUNzRCxRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCekQsRUFBQUEsaUJBQWlCLENBQUMwQixVQUFsQjtBQUNILENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgZ2xvYmFsVHJhbnNsYXRlLCBGb3JtLCBQYnhBcGkqL1xuXG5cbmNvbnN0IG1vZHVsZVVzZXJzVUlMZGFwID0ge1xuXG4gICAgLyoqXG4gICAgICogQ2hlY2tib3ggZm9yIExEQVAgYXV0aGVudGljYXRpb24uXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgICR1c2VMZGFwQ2hlY2tib3g6ICQoJyN1c2UtbGRhcC1hdXRoLW1ldGhvZCcpLFxuXG4gICAgLyoqXG4gICAgICogU2V0IG9mIGZvcm0gZmllbGRzIHRvIHVzZSBmb3IgTERBUCBhdXRoZW50aWNhdGlvbi5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgJGZvcm1GaWVsZHNGb3JMZGFwU2V0dGluZ3M6ICQoJy5kaXNhYmxlLWlmLW5vLWxkYXAnKSxcblxuICAgIC8qKlxuICAgICAqIFNldCBvZiBlbGVtZW50cyBvZiB0aGUgZm9ybSBhZGhlcmVkIHRvIGxkYXAgYXV0aCBtZXRob2QuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgICRmb3JtRWxlbWVudHNBdmFpbGFibGVJZkxkYXBJc09uOiAkKCcuc2hvdy1vbmx5LWlmLWxkYXAtZW5hYmxlZCcpLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIGxkYXAgY2hlY2sgc2VnbWVudC5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRsZGFwQ2hlY2tTZWdtZW50OiAkKCcjbGRhcC1jaGVjay1hdXRoJyksXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgZm9ybS5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRmb3JtT2JqOiAkKCcjbW9kdWxlLXVzZXJzLXVpLWxkYXAtZm9ybScpLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIGNoZWNrIGNyZWRlbnRpYWxzIGJ1dHRvbi5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRjaGVja0F1dGhCdXR0b246ICQoJy5jaGVjay1sZGFwLWNyZWRlbnRpYWxzLmJ1dHRvbicpLFxuXG4gICAgLyoqXG4gICAgICogVmFsaWRhdGlvbiBydWxlcyBmb3IgdGhlIGZvcm0gZmllbGRzLlxuICAgICAqIEB0eXBlIHtPYmplY3R9XG4gICAgICovXG4gICAgdmFsaWRhdGVSdWxlczoge1xuICAgICAgICBzZXJ2ZXJOYW1lOiB7XG4gICAgICAgICAgICBpZGVudGlmaWVyOiAnc2VydmVyTmFtZScsXG4gICAgICAgICAgICBydWxlczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2VtcHR5JyxcbiAgICAgICAgICAgICAgICAgICAgcHJvbXB0OiBnbG9iYWxUcmFuc2xhdGUubW9kdWxlX3VzZXJzdWlfVmFsaWRhdGVTZXJ2ZXJOYW1lSXNFbXB0eSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgc2VydmVyUG9ydDoge1xuICAgICAgICAgICAgaWRlbnRpZmllcjogJ3NlcnZlclBvcnQnLFxuICAgICAgICAgICAgcnVsZXM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdlbXB0eScsXG4gICAgICAgICAgICAgICAgICAgIHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLm1vZHVsZV91c2Vyc3VpX1ZhbGlkYXRlU2VydmVyUG9ydElzRW1wdHksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIGFkbWluaXN0cmF0aXZlTG9naW46IHtcbiAgICAgICAgICAgIGlkZW50aWZpZXI6ICdhZG1pbmlzdHJhdGl2ZUxvZ2luJyxcbiAgICAgICAgICAgIHJ1bGVzOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZW1wdHknLFxuICAgICAgICAgICAgICAgICAgICBwcm9tcHQ6IGdsb2JhbFRyYW5zbGF0ZS5tb2R1bGVfdXNlcnN1aV9WYWxpZGF0ZUFkbWluaXN0cmF0aXZlTG9naW5Jc0VtcHR5LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgICBhZG1pbmlzdHJhdGl2ZVBhc3N3b3JkSGlkZGVuOiB7XG4gICAgICAgICAgICBpZGVudGlmaWVyOiAnYWRtaW5pc3RyYXRpdmVQYXNzd29yZEhpZGRlbicsXG4gICAgICAgICAgICBydWxlczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2VtcHR5JyxcbiAgICAgICAgICAgICAgICAgICAgcHJvbXB0OiBnbG9iYWxUcmFuc2xhdGUubW9kdWxlX3VzZXJzdWlfVmFsaWRhdGVBZG1pbmlzdHJhdGl2ZVBhc3N3b3JkSXNFbXB0eSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgYmFzZUROOiB7XG4gICAgICAgICAgICBpZGVudGlmaWVyOiAnYmFzZUROJyxcbiAgICAgICAgICAgIHJ1bGVzOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZW1wdHknLFxuICAgICAgICAgICAgICAgICAgICBwcm9tcHQ6IGdsb2JhbFRyYW5zbGF0ZS5tb2R1bGVfdXNlcnN1aV9WYWxpZGF0ZUJhc2VETklzRW1wdHksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIHVzZXJJZEF0dHJpYnV0ZToge1xuICAgICAgICAgICAgaWRlbnRpZmllcjogJ3VzZXJJZEF0dHJpYnV0ZScsXG4gICAgICAgICAgICBydWxlczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2VtcHR5JyxcbiAgICAgICAgICAgICAgICAgICAgcHJvbXB0OiBnbG9iYWxUcmFuc2xhdGUubW9kdWxlX3VzZXJzdWlfVmFsaWRhdGVVc2VySWRBdHRyaWJ1dGVJc0VtcHR5LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgbW9kdWxlLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIG1vZHVsZVVzZXJzVUlMZGFwLmluaXRpYWxpemVGb3JtKCk7XG5cbiAgICAgICAgLy8gSGFuZGxlIGNoZWNrIGJ1dHRvbiBjbGlja1xuICAgICAgICBtb2R1bGVVc2Vyc1VJTGRhcC4kY2hlY2tBdXRoQnV0dG9uLmFwaSh7XG4gICAgICAgICAgICB1cmw6IGAke2dsb2JhbFJvb3RVcmx9bW9kdWxlLXVzZXJzLXUtaS9sZGFwLWNvbmZpZy9jaGVjay1hdXRoYCxcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgYmVmb3JlU2VuZChzZXR0aW5ncykge1xuICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoJ2xvYWRpbmcgZGlzYWJsZWQnKTtcbiAgICAgICAgICAgICAgICBzZXR0aW5ncy5kYXRhID0gbW9kdWxlVXNlcnNVSUxkYXAuJGZvcm1PYmouZm9ybSgnZ2V0IHZhbHVlcycpO1xuICAgICAgICAgICAgICAgIHJldHVybiBzZXR0aW5ncztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzdWNjZXNzVGVzdChyZXNwb25zZSl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN1Y2Nlc3M7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBIYW5kbGVzIHRoZSBzdWNjZXNzZnVsIHJlc3BvbnNlIG9mIHRoZSAnY2hlY2stbGRhcC1hdXRoJyBBUEkgcmVxdWVzdC5cbiAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZXNwb25zZSAtIFRoZSByZXNwb25zZSBvYmplY3QuXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIG9uU3VjY2VzczogZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAkKHRoaXMpLnJlbW92ZUNsYXNzKCdsb2FkaW5nIGRpc2FibGVkJyk7XG4gICAgICAgICAgICAgICAgJCgnLnVpLm1lc3NhZ2UuYWpheCcpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIG1vZHVsZVVzZXJzVUlMZGFwLiRsZGFwQ2hlY2tTZWdtZW50LmFmdGVyKGA8ZGl2IGNsYXNzPVwidWkgaWNvbiBtZXNzYWdlIGFqYXggcG9zaXRpdmVcIj48aSBjbGFzcz1cImljb24gY2hlY2tcIj48L2k+ICR7cmVzcG9uc2UubWVzc2FnZX08L2Rpdj5gKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIEhhbmRsZXMgdGhlIGZhaWx1cmUgcmVzcG9uc2Ugb2YgdGhlICdjaGVjay1sZGFwLWF1dGgnIEFQSSByZXF1ZXN0LlxuICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIG9iamVjdC5cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgb25GYWlsdXJlOiBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgICQodGhpcykucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcgZGlzYWJsZWQnKTtcbiAgICAgICAgICAgICAgICAkKCcudWkubWVzc2FnZS5hamF4JykucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgbW9kdWxlVXNlcnNVSUxkYXAuJGxkYXBDaGVja1NlZ21lbnQuYWZ0ZXIoYDxkaXYgY2xhc3M9XCJ1aSBpY29uIG1lc3NhZ2UgYWpheCBuZWdhdGl2ZVwiPjxpIGNsYXNzPVwiaWNvbiBleGNsYW1hdGlvbiBjaXJjbGVcIj48L2k+JHtyZXNwb25zZS5tZXNzYWdlfTwvZGl2PmApO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gR2VuZXJhbCBsZGFwIHN3aXRjaGVyXG4gICAgICAgIG1vZHVsZVVzZXJzVUlMZGFwLiR1c2VMZGFwQ2hlY2tib3guY2hlY2tib3goe1xuICAgICAgICAgICAgb25DaGFuZ2U6IG1vZHVsZVVzZXJzVUlMZGFwLm9uQ2hhbmdlTGRhcENoZWNrYm94LFxuICAgICAgICB9KTtcbiAgICAgICAgbW9kdWxlVXNlcnNVSUxkYXAub25DaGFuZ2VMZGFwQ2hlY2tib3goKTtcblxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBIYW5kbGVzIHRoZSBjaGFuZ2Ugb2YgdGhlIExEQVAgY2hlY2tib3guXG4gICAgICovXG4gICAgb25DaGFuZ2VMZGFwQ2hlY2tib3goKXtcbiAgICAgICAgaWYgKG1vZHVsZVVzZXJzVUlMZGFwLiR1c2VMZGFwQ2hlY2tib3guY2hlY2tib3goJ2lzIGNoZWNrZWQnKSkge1xuICAgICAgICAgICAgbW9kdWxlVXNlcnNVSUxkYXAuJGZvcm1GaWVsZHNGb3JMZGFwU2V0dGluZ3MucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgICAgICBtb2R1bGVVc2Vyc1VJTGRhcC4kZm9ybUVsZW1lbnRzQXZhaWxhYmxlSWZMZGFwSXNPbi5zaG93KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtb2R1bGVVc2Vyc1VJTGRhcC4kZm9ybUZpZWxkc0ZvckxkYXBTZXR0aW5ncy5hZGRDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgICAgIG1vZHVsZVVzZXJzVUlMZGFwLiRmb3JtRWxlbWVudHNBdmFpbGFibGVJZkxkYXBJc09uLmhpZGUoKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBiZWZvcmUgc2VuZGluZyB0aGUgZm9ybS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gc2V0dGluZ3MgLSBUaGUgc2V0dGluZ3Mgb2JqZWN0LlxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9IC0gVGhlIG1vZGlmaWVkIHNldHRpbmdzIG9iamVjdC5cbiAgICAgKi9cbiAgICBjYkJlZm9yZVNlbmRGb3JtKHNldHRpbmdzKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHNldHRpbmdzO1xuICAgICAgICByZXN1bHQuZGF0YSA9IG1vZHVsZVVzZXJzVUlMZGFwLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcbiAgICAgICAgaWYgKG1vZHVsZVVzZXJzVUlMZGFwLiR1c2VMZGFwQ2hlY2tib3guY2hlY2tib3goJ2lzIGNoZWNrZWQnKSl7XG4gICAgICAgICAgICByZXN1bHQuZGF0YS51c2VMZGFwQXV0aE1ldGhvZCA9ICcxJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdC5kYXRhLnVzZUxkYXBBdXRoTWV0aG9kID0gJzAnO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgc2VuZGluZyB0aGUgZm9ybS5cbiAgICAgKi9cbiAgICBjYkFmdGVyU2VuZEZvcm0oKSB7XG4gICAgICAgIC8vIENhbGxiYWNrIGltcGxlbWVudGF0aW9uXG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSBmb3JtLlxuICAgICAqL1xuICAgIGluaXRpYWxpemVGb3JtKCkge1xuICAgICAgICBGb3JtLiRmb3JtT2JqID0gbW9kdWxlVXNlcnNVSUxkYXAuJGZvcm1PYmo7XG4gICAgICAgIEZvcm0udXJsID0gYCR7Z2xvYmFsUm9vdFVybH1tb2R1bGUtdXNlcnMtdS1pL2xkYXAtY29uZmlnL3NhdmVgO1xuICAgICAgICBGb3JtLnZhbGlkYXRlUnVsZXMgPSBtb2R1bGVVc2Vyc1VJTGRhcC52YWxpZGF0ZVJ1bGVzO1xuICAgICAgICBGb3JtLmNiQmVmb3JlU2VuZEZvcm0gPSBtb2R1bGVVc2Vyc1VJTGRhcC5jYkJlZm9yZVNlbmRGb3JtO1xuICAgICAgICBGb3JtLmNiQWZ0ZXJTZW5kRm9ybSA9IG1vZHVsZVVzZXJzVUlMZGFwLmNiQWZ0ZXJTZW5kRm9ybTtcbiAgICAgICAgRm9ybS5pbml0aWFsaXplKCk7XG4gICAgfSxcbn07XG5cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBtb2R1bGVVc2Vyc1VJTGRhcC5pbml0aWFsaXplKCk7XG59KTtcbiJdfQ==