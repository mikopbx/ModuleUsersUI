/*
 * MikoPBX - free phone system for small business
 * Copyright © 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright © 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl,globalTranslate, Form, Extensions */
var moduleUsersUIModifyAG = {
  $formObj: $('#module-users-ui-form'),
  $selectUsersDropDown: $('.select-extension-field'),
  $dirrtyField: $('#dirrty'),
  $statusToggle: $('#module-status-toggle'),
  defaultExtension: '',
  validateRules: {
    name: {
      identifier: 'name',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.module_usersui_ValidateNameIsEmpty
      }]
    }
  },
  initialize: function initialize() {
    var _this = this;

    moduleUsersUIModifyAG.checkStatusToggle();
    window.addEventListener('ModuleStatusChanged', moduleUsersUIModifyAG.checkStatusToggle);
    moduleUsersUIModifyAG.initializeForm();
    $('.avatar').each(function () {
      if ($(_this).attr('src') === '') {
        $(_this).attr('src', "".concat(globalRootUrl, "assets/img/unknownPerson.jpg"));
      }
    });
    $('#main-users-ui-tab-menu .item').tab();
    moduleUsersUIModifyAG.initializeUsersDropDown();
    $('body').on('click', 'div.delete-user-row', function (e) {
      e.preventDefault();
      moduleUsersUIModifyAG.deleteMemberFromTable(e.target);
    });
    $('#isolate').parent().checkbox({
      onChange: moduleUsersUIModifyAG.changeIsolate
    });
    moduleUsersUIModifyAG.changeIsolate();
  },
  changeIsolate: function changeIsolate() {
    if ($('#isolate').parent().checkbox('is checked')) {
      $("#isolatePickUp").parent().hide();
    } else {
      $("#isolatePickUp").parent().show();
    }
  },

  /**
   * Delete Group member from list
   * @param target - link to pushed button
   */
  deleteMemberFromTable: function deleteMemberFromTable(target) {
    var id = $(target).closest('div').attr('data-value');
    $("#".concat(id)).removeClass('selected-member').hide();
    moduleUsersUIModifyAG.$dirrtyField.val(Math.random());
    moduleUsersUIModifyAG.$dirrtyField.trigger('change');
  },

  /**
   * Настройка выпадающего списка пользователей
   */
  initializeUsersDropDown: function initializeUsersDropDown() {
    var dropdownParams = Extensions.getDropdownSettingsOnlyInternalWithoutEmpty();
    dropdownParams.action = moduleUsersUIModifyAG.cbAfterUsersSelect;
    dropdownParams.templates = {
      menu: moduleUsersUIModifyAG.customDropdownMenu
    };
    moduleUsersUIModifyAG.$selectUsersDropDown.dropdown(dropdownParams);
  },

  /**
   * Change custom menu visualisation
   * @param response
   * @param fields
   * @returns {string}
   */
  customDropdownMenu: function customDropdownMenu(response, fields) {
    var values = response[fields.values] || {};
    var html = '';
    var oldType = '';
    $.each(values, function (index, option) {
      if (option.type !== oldType) {
        oldType = option.type;
        html += '<div class="divider"></div>';
        html += '	<div class="header">';
        html += '	<i class="tags icon"></i>';
        html += option.typeLocalized;
        html += '</div>';
      }

      var maybeText = option[fields.text] ? "data-text=\"".concat(option[fields.text], "\"") : '';
      var maybeDisabled = $("#ext-".concat(option[fields.value])).hasClass('selected-member') ? 'disabled ' : '';
      html += "<div class=\"".concat(maybeDisabled, "item\" data-value=\"").concat(option[fields.value], "\"").concat(maybeText, ">");
      html += option[fields.name];
      html += '</div>';
    });
    return html;
  },

  /**
   * Колбек после выбора пользователя в группу
   * @param value
   */
  cbAfterUsersSelect: function cbAfterUsersSelect(text, value, $element) {
    $("#ext-".concat(value)).closest('tr').addClass('selected-member').show();
    $($element).addClass('disabled');
    moduleUsersUIModifyAG.$dirrtyField.val(Math.random());
    moduleUsersUIModifyAG.$dirrtyField.trigger('change');
  },

  /**
   * Изменение статуса кнопок при изменении статуса модуля
   */
  checkStatusToggle: function checkStatusToggle() {
    if (moduleUsersUIModifyAG.$statusToggle.checkbox('is checked')) {
      $('[data-tab = "general"] .disability').removeClass('disabled');
      $('[data-tab="rules"] .checkbox').removeClass('disabled');
      $('[data-tab = "users"] .disability').removeClass('disabled');
    } else {
      $('[data-tab = "general"] .disability').addClass('disabled');
      $('[data-tab="rules"] .checkbox').addClass('disabled');
      $('[data-tab = "users"] .disability').addClass('disabled');
    }
  },
  cbBeforeSendForm: function cbBeforeSendForm(settings) {
    var result = settings;
    result.data = moduleUsersUIModifyAG.$formObj.form('get values');
    var arrMembers = [];
    $('tr.selected-member').each(function (index, obj) {
      if ($(obj).attr('id')) {
        arrMembers.push($(obj).attr('id'));
      }
    });
    result.data.members = JSON.stringify(arrMembers);
    return result;
  },
  cbAfterSendForm: function cbAfterSendForm() {},
  initializeForm: function initializeForm() {
    Form.$formObj = moduleUsersUIModifyAG.$formObj;
    Form.url = "".concat(globalRootUrl, "module-users-groups/save");
    Form.validateRules = moduleUsersUIModifyAG.validateRules;
    Form.cbBeforeSendForm = moduleUsersUIModifyAG.cbBeforeSendForm;
    Form.cbAfterSendForm = moduleUsersUIModifyAG.cbAfterSendForm;
    Form.initialize();
  }
};
$(document).ready(function () {
  moduleUsersUIModifyAG.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUtdXNlcnMtdWktbW9kaWZ5LWFnLmpzIl0sIm5hbWVzIjpbIm1vZHVsZVVzZXJzVUlNb2RpZnlBRyIsIiRmb3JtT2JqIiwiJCIsIiRzZWxlY3RVc2Vyc0Ryb3BEb3duIiwiJGRpcnJ0eUZpZWxkIiwiJHN0YXR1c1RvZ2dsZSIsImRlZmF1bHRFeHRlbnNpb24iLCJ2YWxpZGF0ZVJ1bGVzIiwibmFtZSIsImlkZW50aWZpZXIiLCJydWxlcyIsInR5cGUiLCJwcm9tcHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJtb2R1bGVfdXNlcnN1aV9WYWxpZGF0ZU5hbWVJc0VtcHR5IiwiaW5pdGlhbGl6ZSIsImNoZWNrU3RhdHVzVG9nZ2xlIiwid2luZG93IiwiYWRkRXZlbnRMaXN0ZW5lciIsImluaXRpYWxpemVGb3JtIiwiZWFjaCIsImF0dHIiLCJnbG9iYWxSb290VXJsIiwidGFiIiwiaW5pdGlhbGl6ZVVzZXJzRHJvcERvd24iLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImRlbGV0ZU1lbWJlckZyb21UYWJsZSIsInRhcmdldCIsInBhcmVudCIsImNoZWNrYm94Iiwib25DaGFuZ2UiLCJjaGFuZ2VJc29sYXRlIiwiaGlkZSIsInNob3ciLCJpZCIsImNsb3Nlc3QiLCJyZW1vdmVDbGFzcyIsInZhbCIsIk1hdGgiLCJyYW5kb20iLCJ0cmlnZ2VyIiwiZHJvcGRvd25QYXJhbXMiLCJFeHRlbnNpb25zIiwiZ2V0RHJvcGRvd25TZXR0aW5nc09ubHlJbnRlcm5hbFdpdGhvdXRFbXB0eSIsImFjdGlvbiIsImNiQWZ0ZXJVc2Vyc1NlbGVjdCIsInRlbXBsYXRlcyIsIm1lbnUiLCJjdXN0b21Ecm9wZG93bk1lbnUiLCJkcm9wZG93biIsInJlc3BvbnNlIiwiZmllbGRzIiwidmFsdWVzIiwiaHRtbCIsIm9sZFR5cGUiLCJpbmRleCIsIm9wdGlvbiIsInR5cGVMb2NhbGl6ZWQiLCJtYXliZVRleHQiLCJ0ZXh0IiwibWF5YmVEaXNhYmxlZCIsInZhbHVlIiwiaGFzQ2xhc3MiLCIkZWxlbWVudCIsImFkZENsYXNzIiwiY2JCZWZvcmVTZW5kRm9ybSIsInNldHRpbmdzIiwicmVzdWx0IiwiZGF0YSIsImZvcm0iLCJhcnJNZW1iZXJzIiwib2JqIiwicHVzaCIsIm1lbWJlcnMiLCJKU09OIiwic3RyaW5naWZ5IiwiY2JBZnRlclNlbmRGb3JtIiwiRm9ybSIsInVybCIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUdBLElBQU1BLHFCQUFxQixHQUFHO0FBQzFCQyxFQUFBQSxRQUFRLEVBQUVDLENBQUMsQ0FBQyx1QkFBRCxDQURlO0FBRTFCQyxFQUFBQSxvQkFBb0IsRUFBRUQsQ0FBQyxDQUFDLHlCQUFELENBRkc7QUFHMUJFLEVBQUFBLFlBQVksRUFBRUYsQ0FBQyxDQUFDLFNBQUQsQ0FIVztBQUkxQkcsRUFBQUEsYUFBYSxFQUFFSCxDQUFDLENBQUMsdUJBQUQsQ0FKVTtBQUsxQkksRUFBQUEsZ0JBQWdCLEVBQUUsRUFMUTtBQU0xQkMsRUFBQUEsYUFBYSxFQUFFO0FBQ1hDLElBQUFBLElBQUksRUFBRTtBQUNGQyxNQUFBQSxVQUFVLEVBQUUsTUFEVjtBQUVGQyxNQUFBQSxLQUFLLEVBQUUsQ0FDSDtBQUNJQyxRQUFBQSxJQUFJLEVBQUUsT0FEVjtBQUVJQyxRQUFBQSxNQUFNLEVBQUVDLGVBQWUsQ0FBQ0M7QUFGNUIsT0FERztBQUZMO0FBREssR0FOVztBQWlCMUJDLEVBQUFBLFVBakIwQix3QkFpQmI7QUFBQTs7QUFDVGYsSUFBQUEscUJBQXFCLENBQUNnQixpQkFBdEI7QUFDQUMsSUFBQUEsTUFBTSxDQUFDQyxnQkFBUCxDQUF3QixxQkFBeEIsRUFBK0NsQixxQkFBcUIsQ0FBQ2dCLGlCQUFyRTtBQUNBaEIsSUFBQUEscUJBQXFCLENBQUNtQixjQUF0QjtBQUNBakIsSUFBQUEsQ0FB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IC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLGdsb2JhbFRyYW5zbGF0ZSwgRm9ybSwgRXh0ZW5zaW9ucyAqL1xuXG5cbmNvbnN0IG1vZHVsZVVzZXJzVUlNb2RpZnlBRyA9IHtcbiAgICAkZm9ybU9iajogJCgnI21vZHVsZS11c2Vycy11aS1mb3JtJyksXG4gICAgJHNlbGVjdFVzZXJzRHJvcERvd246ICQoJy5zZWxlY3QtZXh0ZW5zaW9uLWZpZWxkJyksXG4gICAgJGRpcnJ0eUZpZWxkOiAkKCcjZGlycnR5JyksXG4gICAgJHN0YXR1c1RvZ2dsZTogJCgnI21vZHVsZS1zdGF0dXMtdG9nZ2xlJyksXG4gICAgZGVmYXVsdEV4dGVuc2lvbjogJycsXG4gICAgdmFsaWRhdGVSdWxlczoge1xuICAgICAgICBuYW1lOiB7XG4gICAgICAgICAgICBpZGVudGlmaWVyOiAnbmFtZScsXG4gICAgICAgICAgICBydWxlczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2VtcHR5JyxcbiAgICAgICAgICAgICAgICAgICAgcHJvbXB0OiBnbG9iYWxUcmFuc2xhdGUubW9kdWxlX3VzZXJzdWlfVmFsaWRhdGVOYW1lSXNFbXB0eSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICB9LFxuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIG1vZHVsZVVzZXJzVUlNb2RpZnlBRy5jaGVja1N0YXR1c1RvZ2dsZSgpO1xuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignTW9kdWxlU3RhdHVzQ2hhbmdlZCcsIG1vZHVsZVVzZXJzVUlNb2RpZnlBRy5jaGVja1N0YXR1c1RvZ2dsZSk7XG4gICAgICAgIG1vZHVsZVVzZXJzVUlNb2RpZnlBRy5pbml0aWFsaXplRm9ybSgpO1xuICAgICAgICAkKCcuYXZhdGFyJykuZWFjaCgoKSA9PiB7XG4gICAgICAgICAgICBpZiAoJCh0aGlzKS5hdHRyKCdzcmMnKSA9PT0gJycpIHtcbiAgICAgICAgICAgICAgICAkKHRoaXMpLmF0dHIoJ3NyYycsIGAke2dsb2JhbFJvb3RVcmx9YXNzZXRzL2ltZy91bmtub3duUGVyc29uLmpwZ2ApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgJCgnI21haW4tdXNlcnMtdWktdGFiLW1lbnUgLml0ZW0nKS50YWIoKVxuXG4gICAgICAgIG1vZHVsZVVzZXJzVUlNb2RpZnlBRy5pbml0aWFsaXplVXNlcnNEcm9wRG93bigpO1xuXG4gICAgICAgICQoJ2JvZHknKS5vbignY2xpY2snLCAnZGl2LmRlbGV0ZS11c2VyLXJvdycsIChlKSA9PiB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBtb2R1bGVVc2Vyc1VJTW9kaWZ5QUcuZGVsZXRlTWVtYmVyRnJvbVRhYmxlKGUudGFyZ2V0KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgJCgnI2lzb2xhdGUnKS5wYXJlbnQoKS5jaGVja2JveCh7XG4gICAgICAgICAgICBvbkNoYW5nZTogbW9kdWxlVXNlcnNVSU1vZGlmeUFHLmNoYW5nZUlzb2xhdGVcbiAgICAgICAgfSk7XG4gICAgICAgIG1vZHVsZVVzZXJzVUlNb2RpZnlBRy5jaGFuZ2VJc29sYXRlKCk7XG4gICAgfSxcblxuICAgIGNoYW5nZUlzb2xhdGUoKXtcbiAgICAgICAgaWYoJCgnI2lzb2xhdGUnKS5wYXJlbnQoKS5jaGVja2JveCgnaXMgY2hlY2tlZCcpKXtcbiAgICAgICAgICAgICQoXCIjaXNvbGF0ZVBpY2tVcFwiKS5wYXJlbnQoKS5oaWRlKCk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgJChcIiNpc29sYXRlUGlja1VwXCIpLnBhcmVudCgpLnNob3coKTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgLyoqXG4gICAgICogRGVsZXRlIEdyb3VwIG1lbWJlciBmcm9tIGxpc3RcbiAgICAgKiBAcGFyYW0gdGFyZ2V0IC0gbGluayB0byBwdXNoZWQgYnV0dG9uXG4gICAgICovXG4gICAgZGVsZXRlTWVtYmVyRnJvbVRhYmxlKHRhcmdldCkge1xuICAgICAgICBjb25zdCBpZCA9ICQodGFyZ2V0KS5jbG9zZXN0KCdkaXYnKS5hdHRyKCdkYXRhLXZhbHVlJyk7XG4gICAgICAgICQoYCMke2lkfWApXG4gICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ3NlbGVjdGVkLW1lbWJlcicpXG4gICAgICAgICAgICAuaGlkZSgpO1xuICAgICAgICBtb2R1bGVVc2Vyc1VJTW9kaWZ5QUcuJGRpcnJ0eUZpZWxkLnZhbChNYXRoLnJhbmRvbSgpKTtcbiAgICAgICAgbW9kdWxlVXNlcnNVSU1vZGlmeUFHLiRkaXJydHlGaWVsZC50cmlnZ2VyKCdjaGFuZ2UnKTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqINCd0LDRgdGC0YDQvtC50LrQsCDQstGL0L/QsNC00LDRjtGJ0LXQs9C+INGB0L/QuNGB0LrQsCDQv9C+0LvRjNC30L7QstCw0YLQtdC70LXQuVxuICAgICAqL1xuICAgIGluaXRpYWxpemVVc2Vyc0Ryb3BEb3duKCkge1xuICAgICAgICBjb25zdCBkcm9wZG93blBhcmFtcyA9IEV4dGVuc2lvbnMuZ2V0RHJvcGRvd25TZXR0aW5nc09ubHlJbnRlcm5hbFdpdGhvdXRFbXB0eSgpO1xuICAgICAgICBkcm9wZG93blBhcmFtcy5hY3Rpb24gPSBtb2R1bGVVc2Vyc1VJTW9kaWZ5QUcuY2JBZnRlclVzZXJzU2VsZWN0O1xuICAgICAgICBkcm9wZG93blBhcmFtcy50ZW1wbGF0ZXMgPSB7IG1lbnU6IG1vZHVsZVVzZXJzVUlNb2RpZnlBRy5jdXN0b21Ecm9wZG93bk1lbnUgfTtcbiAgICAgICAgbW9kdWxlVXNlcnNVSU1vZGlmeUFHLiRzZWxlY3RVc2Vyc0Ryb3BEb3duLmRyb3Bkb3duKGRyb3Bkb3duUGFyYW1zKTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIENoYW5nZSBjdXN0b20gbWVudSB2aXN1YWxpc2F0aW9uXG4gICAgICogQHBhcmFtIHJlc3BvbnNlXG4gICAgICogQHBhcmFtIGZpZWxkc1xuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgY3VzdG9tRHJvcGRvd25NZW51KHJlc3BvbnNlLCBmaWVsZHMpIHtcbiAgICAgICAgY29uc3QgdmFsdWVzID0gcmVzcG9uc2VbZmllbGRzLnZhbHVlc10gfHwge307XG4gICAgICAgIGxldCBodG1sID0gJyc7XG4gICAgICAgIGxldCBvbGRUeXBlID0gJyc7XG4gICAgICAgICQuZWFjaCh2YWx1ZXMsIChpbmRleCwgb3B0aW9uKSA9PiB7XG4gICAgICAgICAgICBpZiAob3B0aW9uLnR5cGUgIT09IG9sZFR5cGUpIHtcbiAgICAgICAgICAgICAgICBvbGRUeXBlID0gb3B0aW9uLnR5cGU7XG4gICAgICAgICAgICAgICAgaHRtbCArPSAnPGRpdiBjbGFzcz1cImRpdmlkZXJcIj48L2Rpdj4nO1xuICAgICAgICAgICAgICAgIGh0bWwgKz0gJ1x0PGRpdiBjbGFzcz1cImhlYWRlclwiPic7XG4gICAgICAgICAgICAgICAgaHRtbCArPSAnXHQ8aSBjbGFzcz1cInRhZ3MgaWNvblwiPjwvaT4nO1xuICAgICAgICAgICAgICAgIGh0bWwgKz0gb3B0aW9uLnR5cGVMb2NhbGl6ZWQ7XG4gICAgICAgICAgICAgICAgaHRtbCArPSAnPC9kaXY+JztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IG1heWJlVGV4dCA9IChvcHRpb25bZmllbGRzLnRleHRdKSA/IGBkYXRhLXRleHQ9XCIke29wdGlvbltmaWVsZHMudGV4dF19XCJgIDogJyc7XG4gICAgICAgICAgICBjb25zdCBtYXliZURpc2FibGVkID0gKCQoYCNleHQtJHtvcHRpb25bZmllbGRzLnZhbHVlXX1gKS5oYXNDbGFzcygnc2VsZWN0ZWQtbWVtYmVyJykpID8gJ2Rpc2FibGVkICcgOiAnJztcbiAgICAgICAgICAgIGh0bWwgKz0gYDxkaXYgY2xhc3M9XCIke21heWJlRGlzYWJsZWR9aXRlbVwiIGRhdGEtdmFsdWU9XCIke29wdGlvbltmaWVsZHMudmFsdWVdfVwiJHttYXliZVRleHR9PmA7XG4gICAgICAgICAgICBodG1sICs9IG9wdGlvbltmaWVsZHMubmFtZV07XG4gICAgICAgICAgICBodG1sICs9ICc8L2Rpdj4nO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGh0bWw7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDQmtC+0LvQsdC10Log0L/QvtGB0LvQtSDQstGL0LHQvtGA0LAg0L/QvtC70YzQt9C+0LLQsNGC0LXQu9GPINCyINCz0YDRg9C/0L/Rg1xuICAgICAqIEBwYXJhbSB2YWx1ZVxuICAgICAqL1xuICAgIGNiQWZ0ZXJVc2Vyc1NlbGVjdCh0ZXh0LCB2YWx1ZSwgJGVsZW1lbnQpIHtcbiAgICAgICAgJChgI2V4dC0ke3ZhbHVlfWApXG4gICAgICAgICAgICAuY2xvc2VzdCgndHInKVxuICAgICAgICAgICAgLmFkZENsYXNzKCdzZWxlY3RlZC1tZW1iZXInKVxuICAgICAgICAgICAgLnNob3coKTtcbiAgICAgICAgJCgkZWxlbWVudCkuYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgIG1vZHVsZVVzZXJzVUlNb2RpZnlBRy4kZGlycnR5RmllbGQudmFsKE1hdGgucmFuZG9tKCkpO1xuICAgICAgICBtb2R1bGVVc2Vyc1VJTW9kaWZ5QUcuJGRpcnJ0eUZpZWxkLnRyaWdnZXIoJ2NoYW5nZScpO1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog0JjQt9C80LXQvdC10L3QuNC1INGB0YLQsNGC0YPRgdCwINC60L3QvtC/0L7QuiDQv9GA0Lgg0LjQt9C80LXQvdC10L3QuNC4INGB0YLQsNGC0YPRgdCwINC80L7QtNGD0LvRj1xuICAgICAqL1xuICAgIGNoZWNrU3RhdHVzVG9nZ2xlKCkge1xuICAgICAgICBpZiAobW9kdWxlVXNlcnNVSU1vZGlmeUFHLiRzdGF0dXNUb2dnbGUuY2hlY2tib3goJ2lzIGNoZWNrZWQnKSkge1xuICAgICAgICAgICAgJCgnW2RhdGEtdGFiID0gXCJnZW5lcmFsXCJdIC5kaXNhYmlsaXR5JykucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgICAgICAkKCdbZGF0YS10YWI9XCJydWxlc1wiXSAuY2hlY2tib3gnKS5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgICAgICQoJ1tkYXRhLXRhYiA9IFwidXNlcnNcIl0gLmRpc2FiaWxpdHknKS5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICQoJ1tkYXRhLXRhYiA9IFwiZ2VuZXJhbFwiXSAuZGlzYWJpbGl0eScpLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAgICAgJCgnW2RhdGEtdGFiPVwicnVsZXNcIl0gLmNoZWNrYm94JykuYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgICAgICAkKCdbZGF0YS10YWIgPSBcInVzZXJzXCJdIC5kaXNhYmlsaXR5JykuYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIGNiQmVmb3JlU2VuZEZvcm0oc2V0dGluZ3MpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gc2V0dGluZ3M7XG4gICAgICAgIHJlc3VsdC5kYXRhID0gbW9kdWxlVXNlcnNVSU1vZGlmeUFHLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcbiAgICAgICAgY29uc3QgYXJyTWVtYmVycyA9IFtdO1xuICAgICAgICAkKCd0ci5zZWxlY3RlZC1tZW1iZXInKS5lYWNoKChpbmRleCwgb2JqKSA9PiB7XG4gICAgICAgICAgICBpZiAoJChvYmopLmF0dHIoJ2lkJykpIHtcbiAgICAgICAgICAgICAgICBhcnJNZW1iZXJzLnB1c2goJChvYmopLmF0dHIoJ2lkJykpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXN1bHQuZGF0YS5tZW1iZXJzID0gSlNPTi5zdHJpbmdpZnkoYXJyTWVtYmVycyk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSxcbiAgICBjYkFmdGVyU2VuZEZvcm0oKSB7XG5cbiAgICB9LFxuICAgIGluaXRpYWxpemVGb3JtKCkge1xuICAgICAgICBGb3JtLiRmb3JtT2JqID0gbW9kdWxlVXNlcnNVSU1vZGlmeUFHLiRmb3JtT2JqO1xuICAgICAgICBGb3JtLnVybCA9IGAke2dsb2JhbFJvb3RVcmx9bW9kdWxlLXVzZXJzLWdyb3Vwcy9zYXZlYDtcbiAgICAgICAgRm9ybS52YWxpZGF0ZVJ1bGVzID0gbW9kdWxlVXNlcnNVSU1vZGlmeUFHLnZhbGlkYXRlUnVsZXM7XG4gICAgICAgIEZvcm0uY2JCZWZvcmVTZW5kRm9ybSA9IG1vZHVsZVVzZXJzVUlNb2RpZnlBRy5jYkJlZm9yZVNlbmRGb3JtO1xuICAgICAgICBGb3JtLmNiQWZ0ZXJTZW5kRm9ybSA9IG1vZHVsZVVzZXJzVUlNb2RpZnlBRy5jYkFmdGVyU2VuZEZvcm07XG4gICAgICAgIEZvcm0uaW5pdGlhbGl6ZSgpO1xuICAgIH0sXG59O1xuXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgbW9kdWxlVXNlcnNVSU1vZGlmeUFHLmluaXRpYWxpemUoKTtcbn0pO1xuIl19