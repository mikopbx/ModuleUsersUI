"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global SemanticLocalization, globalRootUrl, moduleUsersUiIndexLdap, UserMessage, Datatable */
var ModuleUsersUIUsersTab = {
  /**
   * Users table.
   * @type {jQuery}
   */
  $usersTable: $('#users-table'),

  /**
   * User data table.
   * @type {Datatable}
   */
  userDataTable: null,

  /**
   * Select group dropdowns.
   * @type {jQuery}
   */
  $selectGroup: $('.select-group'),

  /**
   * User use LDAP table checkboxes.
   * @type {jQuery}
   */
  $userUseLdapTableCheckbox: $('.user-use-ldap-checkbox'),

  /**
   * Body.
   * @type {jQuery}
   */
  $body: $('body'),

  /**
   * Initializes the ModuleUsersUIIndex module.
   */
  initialize: function initialize() {
    ModuleUsersUIUsersTab.initializeDataTable();
    ModuleUsersUIUsersTab.$selectGroup.each(function (index, obj) {
      $(obj).dropdown({
        values: ModuleUsersUIUsersTab.makeDropdownList($(obj).attr('data-value'))
      });
    });
    ModuleUsersUIUsersTab.$selectGroup.dropdown({
      onChange: ModuleUsersUIUsersTab.changeGroupInList
    });
    ModuleUsersUIUsersTab.$userUseLdapTableCheckbox.checkbox({
      onChange: ModuleUsersUIUsersTab.changeLdapInList
    }); // Double click on password or login input field in the table

    ModuleUsersUIUsersTab.$body.on('focusin', '.user-login-input, .user-password-input', function (e) {
      $(e.target).transition('glow');
      $(e.target).closest('div').removeClass('transparent').addClass('changed-field');
      $(e.target).attr('readonly', false);

      if (moduleUsersUiIndexLdap.$useLdapCheckbox.checkbox('is checked') && $(e.target).closest('tr').find('.user-use-ldap-checkbox').checkbox('is checked')) {
        $(e.target).closest('div').search({
          // change search endpoint to a custom endpoint by manipulating apiSettings
          apiSettings: {
            url: "".concat(globalRootUrl, "module-users-u-i/ldap-config/search-ldap-user/{query}")
          }
        });
      }
    }); // Submit form on Enter or Tab

    $(document).on('keydown', function (e) {
      var keyCode = e.keyCode || e.which;

      if (keyCode === 13 || keyCode === 9 && !$(':focus').hasClass('.user-login-input') || keyCode === 9 && !$(':focus').hasClass('.user-password-input')) {
        var $el = $('.changed-field').closest('tr');
        $el.each(function (index, obj) {
          var currentRowId = $(obj).attr('id');

          if (currentRowId !== undefined) {
            ModuleUsersUIUsersTab.changeLoginPasswordInList(currentRowId);
          }
        });
      }
    }); // Submit form on focus out from password or login input field

    ModuleUsersUIUsersTab.$body.on('focusout', '.user-login-input, .user-password-input', function (e) {
      var $el = $('.changed-field').closest('tr');
      $el.each(function (index, obj) {
        var currentRowId = $(obj).attr('id');

        if (currentRowId !== undefined) {
          ModuleUsersUIUsersTab.changeLoginPasswordInList(currentRowId);
        }
      });
    });
  },

  /**
   * Initializes the users table DataTable.
   */
  initializeDataTable: function initializeDataTable() {
    $('#main-users-ui-tab-menu .item').tab({
      onVisible: function onVisible() {
        if ($(this).data('tab') === 'users' && ModuleUsersUIUsersTab.userDataTable !== null) {
          var newPageLength = ModuleUsersUIUsersTab.calculatePageLength();
          ModuleUsersUIUsersTab.userDataTable.page.len(newPageLength).draw(false);
        }
      }
    });
    ModuleUsersUIUsersTab.userDataTable = ModuleUsersUIUsersTab.$usersTable.DataTable({
      // destroy: true,
      lengthChange: false,
      paging: true,
      pageLength: ModuleUsersUIUsersTab.calculatePageLength(),
      scrollCollapse: true,
      columns: [// Username
      {
        orderable: true,
        // This column is orderable
        searchable: true // This column is searchable

      }, // Extension
      {
        orderable: true,
        // This column is orderable
        searchable: true // This column is searchable

      }, // Use LDAP
      {
        orderable: false,
        // This column is not orderable
        searchable: false // This column is not searchable

      }, // Login
      {
        orderable: true,
        // This column is orderable
        searchable: true // This column is searchable

      }, // Password
      {
        orderable: false,
        // This column is not orderable
        searchable: false // This column is not searchable

      }, // Access group
      {
        orderable: true,
        // This column is orderable
        searchable: true // This column is searchable

      }],
      order: [0, 'asc'],
      language: SemanticLocalization.dataTableLocalisation
    });
  },

  /**
   * Creates a dropdown list for users.
   * @param {string} selected - The selected value.
   * @returns {Array} - The dropdown list.
   */
  makeDropdownList: function makeDropdownList(selected) {
    var values = [];
    $('#users-groups-list option').each(function (index, obj) {
      if (selected === obj.text || selected === obj.value) {
        values.push({
          name: obj.text,
          value: obj.value,
          selected: true
        });
      } else {
        values.push({
          name: obj.text,
          value: obj.value
        });
      }
    });
    return values;
  },

  /**
   * Handles the change of group in the list.
   * @param {string} value - The selected value.
   * @param {string} text - The selected text.
   * @param {jQuery} $choice - The dropdown element.
   */
  changeGroupInList: function changeGroupInList(value, text, $choice) {
    var rowId = $($choice).closest('tr').attr('id');
    ModuleUsersUIUsersTab.addProgressIcon(rowId);
    $.api({
      url: "".concat(globalRootUrl, "module-users-u-i/users-credentials/change-user-group"),
      on: 'now',
      method: 'POST',
      data: {
        user_id: rowId,
        group_id: value
      },
      successTest: function successTest(response) {
        // test whether a JSON response is valid
        return response !== undefined && Object.keys(response).length > 0 && response.success === true;
      },
      onSuccess: function onSuccess() {
        ModuleUsersUIUsersTab.removeProgressIcon(rowId);
        $('.ui.message.ajax').remove();
      },
      onError: function onError(response) {
        if (response.message !== undefined) {
          UserMessage.showMultiString(response.message);
        }

        ModuleUsersUIUsersTab.removeProgressIcon(rowId);
      },
      onFailure: function onFailure(response) {
        if (response.message !== undefined) {
          UserMessage.showMultiString(response.message);
        }

        ModuleUsersUIUsersTab.removeProgressIcon(rowId);
      }
    });
  },

  /**
   * Handles the change of LDAP checkbox in the list.
   */
  changeLdapInList: function changeLdapInList() {
    var rowId = $(this).closest('tr').attr('id');
    ModuleUsersUIUsersTab.addProgressIcon(rowId);
    $.api({
      url: "".concat(globalRootUrl, "module-users-u-i/users-credentials/change-user-use-ldap"),
      on: 'now',
      method: 'POST',
      data: {
        user_id: rowId,
        useLdap: $(this).parent('.checkbox').checkbox('is checked')
      },
      successTest: function successTest(response) {
        // test whether a JSON response is valid
        return response !== undefined && Object.keys(response).length > 0 && response.success === true;
      },
      onSuccess: function onSuccess() {
        ModuleUsersUIUsersTab.removeProgressIcon(rowId);

        if ($("tr#".concat(rowId, " .user-use-ldap-checkbox")).checkbox('is checked')) {
          $("tr#".concat(rowId, " td.password")).hide();
          $("tr#".concat(rowId, " td.login")).attr('colspan', 2);
        } else {
          $("tr#".concat(rowId, " td.password")).show();
          $("tr#".concat(rowId, " td.login")).attr('colspan', 1);
        }

        $('.ui.message.ajax').remove();
      },
      onError: function onError(response) {
        if (response.message !== undefined) {
          UserMessage.showMultiString(response.message);
        }

        ModuleUsersUIUsersTab.removeProgressIcon(rowId);
      },
      onFailure: function onFailure(response) {
        if (response.message !== undefined) {
          UserMessage.showMultiString(response.message);
        }

        ModuleUsersUIUsersTab.removeProgressIcon(rowId);
      }
    });
  },

  /**
   * Changes the login and password in the list.
   * @param {string} rowId - The ID of the row.
   */
  changeLoginPasswordInList: function changeLoginPasswordInList(rowId) {
    var login = $("#".concat(rowId, " input.user-login-input")).val();
    var password = $("#".concat(rowId, " input.user-password-input")).val();
    ModuleUsersUIUsersTab.addProgressIcon(rowId);
    $.api({
      url: "".concat(globalRootUrl, "module-users-u-i/users-credentials/change-user-credentials"),
      on: 'now',
      method: 'POST',
      data: {
        user_id: rowId,
        login: login,
        password: password
      },
      successTest: function successTest(response) {
        // test whether a JSON response is valid
        return response !== undefined && Object.keys(response).length > 0 && response.success === true;
      },
      onSuccess: function onSuccess() {
        ModuleUsersUIUsersTab.removeProgressIcon(rowId);
        $("tr#".concat(rowId, " .changed-field input")).attr('readonly', true);
        $("tr#".concat(rowId, " div.changed-field")).removeClass('changed-field loading').addClass('transparent');
        $('.ui.message.ajax').remove();
      },
      onError: function onError(response) {
        if (response.message !== undefined) {
          UserMessage.showMultiString(response.message);
        }

        ModuleUsersUIUsersTab.removeProgressIcon(rowId);
      },
      onFailure: function onFailure(response) {
        if (response.message !== undefined) {
          UserMessage.showMultiString(response.message);
        }

        ModuleUsersUIUsersTab.removeProgressIcon(rowId);
      }
    });
  },

  /**
   * Adds save icon from the row
   */
  addProgressIcon: function addProgressIcon(rowId) {
    $("tr#".concat(rowId, " .changed-field")).find('.ui.spinner.loading.icon').show();
  },

  /**
   * Removes save icon from the row
   */
  removeProgressIcon: function removeProgressIcon(rowId) {
    $("tr#".concat(rowId, " .changed-field")).find('.ui.spinner.loading.icon').hide();
    $("tr#".concat(rowId, " .changed-field")).closest('div').search('hide results').search('destroy');
  },
  calculatePageLength: function calculatePageLength() {
    // Calculate row height
    var rowHeight = ModuleUsersUIUsersTab.$usersTable.find('tr').first().outerHeight(); // Calculate window height and available space for table

    var windowHeight = window.innerHeight;
    var headerFooterHeight = 400; // Estimate height for header, footer, and other elements
    // Calculate new page length

    return Math.max(Math.floor((windowHeight - headerFooterHeight) / rowHeight), 10);
  }
};
$(document).ready(function () {
  ModuleUsersUIUsersTab.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUtdXNlcnMtdWktaW5kZXgtdXNlcnMuanMiXSwibmFtZXMiOlsiTW9kdWxlVXNlcnNVSVVzZXJzVGFiIiwiJHVzZXJzVGFibGUiLCIkIiwidXNlckRhdGFUYWJsZSIsIiRzZWxlY3RHcm91cCIsIiR1c2VyVXNlTGRhcFRhYmxlQ2hlY2tib3giLCIkYm9keSIsImluaXRpYWxpemUiLCJpbml0aWFsaXplRGF0YVRhYmxlIiwiZWFjaCIsImluZGV4Iiwib2JqIiwiZHJvcGRvd24iLCJ2YWx1ZXMiLCJtYWtlRHJvcGRvd25MaXN0IiwiYXR0ciIsIm9uQ2hhbmdlIiwiY2hhbmdlR3JvdXBJbkxpc3QiLCJjaGVja2JveCIsImNoYW5nZUxkYXBJbkxpc3QiLCJvbiIsImUiLCJ0YXJnZXQiLCJ0cmFuc2l0aW9uIiwiY2xvc2VzdCIsInJlbW92ZUNsYXNzIiwiYWRkQ2xhc3MiLCJtb2R1bGVVc2Vyc1VpSW5kZXhMZGFwIiwiJHVzZUxkYXBDaGVja2JveCIsImZpbmQiLCJzZWFyY2giLCJhcGlTZXR0aW5ncyIsInVybCIsImdsb2JhbFJvb3RVcmwiLCJkb2N1bWVudCIsImtleUNvZGUiLCJ3aGljaCIsImhhc0NsYXNzIiwiJGVsIiwiY3VycmVudFJvd0lkIiwidW5kZWZpbmVkIiwiY2hhbmdlTG9naW5QYXNzd29yZEluTGlzdCIsInRhYiIsIm9uVmlzaWJsZSIsImRhdGEiLCJuZXdQYWdlTGVuZ3RoIiwiY2FsY3VsYXRlUGFnZUxlbmd0aCIsInBhZ2UiLCJsZW4iLCJkcmF3IiwiRGF0YVRhYmxlIiwibGVuZ3RoQ2hhbmdlIiwicGFnaW5nIiwicGFnZUxlbmd0aCIsInNjcm9sbENvbGxhcHNlIiwiY29sdW1ucyIsIm9yZGVyYWJsZSIsInNlYXJjaGFibGUiLCJvcmRlciIsImxhbmd1YWdlIiwiU2VtYW50aWNMb2NhbGl6YXRpb24iLCJkYXRhVGFibGVMb2NhbGlzYXRpb24iLCJzZWxlY3RlZCIsInRleHQiLCJ2YWx1ZSIsInB1c2giLCJuYW1lIiwiJGNob2ljZSIsInJvd0lkIiwiYWRkUHJvZ3Jlc3NJY29uIiwiYXBpIiwibWV0aG9kIiwidXNlcl9pZCIsImdyb3VwX2lkIiwic3VjY2Vzc1Rlc3QiLCJyZXNwb25zZSIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJzdWNjZXNzIiwib25TdWNjZXNzIiwicmVtb3ZlUHJvZ3Jlc3NJY29uIiwicmVtb3ZlIiwib25FcnJvciIsIm1lc3NhZ2UiLCJVc2VyTWVzc2FnZSIsInNob3dNdWx0aVN0cmluZyIsIm9uRmFpbHVyZSIsInVzZUxkYXAiLCJwYXJlbnQiLCJoaWRlIiwic2hvdyIsImxvZ2luIiwidmFsIiwicGFzc3dvcmQiLCJyb3dIZWlnaHQiLCJmaXJzdCIsIm91dGVySGVpZ2h0Iiwid2luZG93SGVpZ2h0Iiwid2luZG93IiwiaW5uZXJIZWlnaHQiLCJoZWFkZXJGb290ZXJIZWlnaHQiLCJNYXRoIiwibWF4IiwiZmxvb3IiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBRUEsSUFBTUEscUJBQXFCLEdBQUc7QUFFMUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsV0FBVyxFQUFFQyxDQUFDLENBQUMsY0FBRCxDQU5ZOztBQVExQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxhQUFhLEVBQUUsSUFaVzs7QUFjMUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsWUFBWSxFQUFFRixDQUFDLENBQUMsZUFBRCxDQWxCVzs7QUFvQjFCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lHLEVBQUFBLHlCQUF5QixFQUFFSCxDQUFDLENBQUMseUJBQUQsQ0F4QkY7O0FBMEIxQjtBQUNKO0FBQ0E7QUFDQTtBQUNJSSxFQUFBQSxLQUFLLEVBQUVKLENBQUMsQ0FBQyxNQUFELENBOUJrQjs7QUFnQzFCO0FBQ0o7QUFDQTtBQUNJSyxFQUFBQSxVQW5DMEIsd0JB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QUNBLFdBQU9DLElBQUksQ0FBQ0MsR0FBTCxDQUFTRCxJQUFJLENBQUNFLEtBQUwsQ0FBVyxDQUFDTixZQUFZLEdBQUdHLGtCQUFoQixJQUFzQ04sU0FBakQsQ0FBVCxFQUFzRSxFQUF0RSxDQUFQO0FBQ0g7QUFsVnlCLENBQTlCO0FBcVZBN0YsQ0FBQyxDQUFDZ0MsUUFBRCxDQUFELENBQVl1RSxLQUFaLENBQWtCLFlBQU07QUFDcEJ6RyxFQUFBQSxxQkFBcUIsQ0FBQ08sVUFBdEI7QUFDSCxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIFNlbWFudGljTG9jYWxpemF0aW9uLCBnbG9iYWxSb290VXJsLCBtb2R1bGVVc2Vyc1VpSW5kZXhMZGFwLCBVc2VyTWVzc2FnZSwgRGF0YXRhYmxlICovXG5cbmNvbnN0IE1vZHVsZVVzZXJzVUlVc2Vyc1RhYiA9IHtcblxuICAgIC8qKlxuICAgICAqIFVzZXJzIHRhYmxlLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHVzZXJzVGFibGU6ICQoJyN1c2Vycy10YWJsZScpLFxuXG4gICAgLyoqXG4gICAgICogVXNlciBkYXRhIHRhYmxlLlxuICAgICAqIEB0eXBlIHtEYXRhdGFibGV9XG4gICAgICovXG4gICAgdXNlckRhdGFUYWJsZTogbnVsbCxcblxuICAgIC8qKlxuICAgICAqIFNlbGVjdCBncm91cCBkcm9wZG93bnMuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkc2VsZWN0R3JvdXA6ICQoJy5zZWxlY3QtZ3JvdXAnKSxcblxuICAgIC8qKlxuICAgICAqIFVzZXIgdXNlIExEQVAgdGFibGUgY2hlY2tib3hlcy5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICR1c2VyVXNlTGRhcFRhYmxlQ2hlY2tib3g6ICQoJy51c2VyLXVzZS1sZGFwLWNoZWNrYm94JyksXG5cbiAgICAvKipcbiAgICAgKiBCb2R5LlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJGJvZHk6ICQoJ2JvZHknKSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSBNb2R1bGVVc2Vyc1VJSW5kZXggbW9kdWxlLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG5cbiAgICAgICAgTW9kdWxlVXNlcnNVSVVzZXJzVGFiLmluaXRpYWxpemVEYXRhVGFibGUoKTtcblxuICAgICAgICBNb2R1bGVVc2Vyc1VJVXNlcnNUYWIuJHNlbGVjdEdyb3VwLmVhY2goKGluZGV4LCBvYmopID0+IHtcbiAgICAgICAgICAgICQob2JqKS5kcm9wZG93bih7XG4gICAgICAgICAgICAgICAgdmFsdWVzOiBNb2R1bGVVc2Vyc1VJVXNlcnNUYWIubWFrZURyb3Bkb3duTGlzdCgkKG9iaikuYXR0cignZGF0YS12YWx1ZScpKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgTW9kdWxlVXNlcnNVSVVzZXJzVGFiLiRzZWxlY3RHcm91cC5kcm9wZG93bih7XG4gICAgICAgICAgICBvbkNoYW5nZTogTW9kdWxlVXNlcnNVSVVzZXJzVGFiLmNoYW5nZUdyb3VwSW5MaXN0LFxuICAgICAgICB9KTtcblxuICAgICAgICBNb2R1bGVVc2Vyc1VJVXNlcnNUYWIuJHVzZXJVc2VMZGFwVGFibGVDaGVja2JveC5jaGVja2JveCh7XG4gICAgICAgICAgICBvbkNoYW5nZTogTW9kdWxlVXNlcnNVSVVzZXJzVGFiLmNoYW5nZUxkYXBJbkxpc3QsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIERvdWJsZSBjbGljayBvbiBwYXNzd29yZCBvciBsb2dpbiBpbnB1dCBmaWVsZCBpbiB0aGUgdGFibGVcbiAgICAgICAgTW9kdWxlVXNlcnNVSVVzZXJzVGFiLiRib2R5Lm9uKCdmb2N1c2luJywgJy51c2VyLWxvZ2luLWlucHV0LCAudXNlci1wYXNzd29yZC1pbnB1dCcsIChlKSA9PiB7XG4gICAgICAgICAgICAkKGUudGFyZ2V0KS50cmFuc2l0aW9uKCdnbG93Jyk7XG5cbiAgICAgICAgICAgICQoZS50YXJnZXQpLmNsb3Nlc3QoJ2RpdicpXG4gICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKCd0cmFuc3BhcmVudCcpXG4gICAgICAgICAgICAgICAgLmFkZENsYXNzKCdjaGFuZ2VkLWZpZWxkJyk7XG4gICAgICAgICAgICAkKGUudGFyZ2V0KS5hdHRyKCdyZWFkb25seScsIGZhbHNlKTtcblxuICAgICAgICAgICAgaWYgKG1vZHVsZVVzZXJzVWlJbmRleExkYXAuJHVzZUxkYXBDaGVja2JveC5jaGVja2JveCgnaXMgY2hlY2tlZCcpXG4gICAgICAgICAgICAgICAgJiYgJChlLnRhcmdldCkuY2xvc2VzdCgndHInKS5maW5kKCcudXNlci11c2UtbGRhcC1jaGVja2JveCcpLmNoZWNrYm94KCdpcyBjaGVja2VkJykpe1xuICAgICAgICAgICAgICAgICQoZS50YXJnZXQpLmNsb3Nlc3QoJ2RpdicpLnNlYXJjaCh7XG4gICAgICAgICAgICAgICAgICAgIC8vIGNoYW5nZSBzZWFyY2ggZW5kcG9pbnQgdG8gYSBjdXN0b20gZW5kcG9pbnQgYnkgbWFuaXB1bGF0aW5nIGFwaVNldHRpbmdzXG4gICAgICAgICAgICAgICAgICAgIGFwaVNldHRpbmdzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGAke2dsb2JhbFJvb3RVcmx9bW9kdWxlLXVzZXJzLXUtaS9sZGFwLWNvbmZpZy9zZWFyY2gtbGRhcC11c2VyL3txdWVyeX1gXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFN1Ym1pdCBmb3JtIG9uIEVudGVyIG9yIFRhYlxuICAgICAgICAkKGRvY3VtZW50KS5vbigna2V5ZG93bicsIChlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBrZXlDb2RlID0gZS5rZXlDb2RlIHx8IGUud2hpY2g7XG4gICAgICAgICAgICBpZiAoa2V5Q29kZSA9PT0gMTNcbiAgICAgICAgICAgICAgICB8fCAoa2V5Q29kZSA9PT0gOSAmJiAhJCgnOmZvY3VzJykuaGFzQ2xhc3MoJy51c2VyLWxvZ2luLWlucHV0JykpXG4gICAgICAgICAgICAgICAgfHwgKGtleUNvZGUgPT09IDkgJiYgISQoJzpmb2N1cycpLmhhc0NsYXNzKCcudXNlci1wYXNzd29yZC1pbnB1dCcpKVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgJGVsID0gJCgnLmNoYW5nZWQtZmllbGQnKS5jbG9zZXN0KCd0cicpO1xuICAgICAgICAgICAgICAgICRlbC5lYWNoKChpbmRleCwgb2JqKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRSb3dJZCA9ICQob2JqKS5hdHRyKCdpZCcpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFJvd0lkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIE1vZHVsZVVzZXJzVUlVc2Vyc1RhYi5jaGFuZ2VMb2dpblBhc3N3b3JkSW5MaXN0KGN1cnJlbnRSb3dJZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU3VibWl0IGZvcm0gb24gZm9jdXMgb3V0IGZyb20gcGFzc3dvcmQgb3IgbG9naW4gaW5wdXQgZmllbGRcbiAgICAgICAgTW9kdWxlVXNlcnNVSVVzZXJzVGFiLiRib2R5Lm9uKCdmb2N1c291dCcsICcudXNlci1sb2dpbi1pbnB1dCwgLnVzZXItcGFzc3dvcmQtaW5wdXQnLCAoZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgJGVsID0gJCgnLmNoYW5nZWQtZmllbGQnKS5jbG9zZXN0KCd0cicpO1xuICAgICAgICAgICAgJGVsLmVhY2goKGluZGV4LCBvYmopID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50Um93SWQgPSAkKG9iaikuYXR0cignaWQnKTtcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFJvd0lkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgTW9kdWxlVXNlcnNVSVVzZXJzVGFiLmNoYW5nZUxvZ2luUGFzc3dvcmRJbkxpc3QoY3VycmVudFJvd0lkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIHVzZXJzIHRhYmxlIERhdGFUYWJsZS5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplRGF0YVRhYmxlKCkge1xuXG4gICAgICAgICQoJyNtYWluLXVzZXJzLXVpLXRhYi1tZW51IC5pdGVtJykudGFiKHtcbiAgICAgICAgICAgIG9uVmlzaWJsZSgpe1xuICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLmRhdGEoJ3RhYicpPT09J3VzZXJzJyAmJiBNb2R1bGVVc2Vyc1VJVXNlcnNUYWIudXNlckRhdGFUYWJsZSE9PW51bGwpe1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdQYWdlTGVuZ3RoID0gTW9kdWxlVXNlcnNVSVVzZXJzVGFiLmNhbGN1bGF0ZVBhZ2VMZW5ndGgoKTtcbiAgICAgICAgICAgICAgICAgICAgTW9kdWxlVXNlcnNVSVVzZXJzVGFiLnVzZXJEYXRhVGFibGUucGFnZS5sZW4obmV3UGFnZUxlbmd0aCkuZHJhdyhmYWxzZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBNb2R1bGVVc2Vyc1VJVXNlcnNUYWIudXNlckRhdGFUYWJsZSA9IE1vZHVsZVVzZXJzVUlVc2Vyc1RhYi4kdXNlcnNUYWJsZS5EYXRhVGFibGUoe1xuICAgICAgICAgICAgLy8gZGVzdHJveTogdHJ1ZSxcbiAgICAgICAgICAgIGxlbmd0aENoYW5nZTogZmFsc2UsXG4gICAgICAgICAgICBwYWdpbmc6IHRydWUsXG4gICAgICAgICAgICBwYWdlTGVuZ3RoOiBNb2R1bGVVc2Vyc1VJVXNlcnNUYWIuY2FsY3VsYXRlUGFnZUxlbmd0aCgpLFxuICAgICAgICAgICAgc2Nyb2xsQ29sbGFwc2U6IHRydWUsXG4gICAgICAgICAgICBjb2x1bW5zOiBbXG4gICAgICAgICAgICAgICAgLy8gVXNlcm5hbWVcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG9yZGVyYWJsZTogdHJ1ZSwgIC8vIFRoaXMgY29sdW1uIGlzIG9yZGVyYWJsZVxuICAgICAgICAgICAgICAgICAgICBzZWFyY2hhYmxlOiB0cnVlICAvLyBUaGlzIGNvbHVtbiBpcyBzZWFyY2hhYmxlXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAvLyBFeHRlbnNpb25cbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG9yZGVyYWJsZTogdHJ1ZSwgIC8vIFRoaXMgY29sdW1uIGlzIG9yZGVyYWJsZVxuICAgICAgICAgICAgICAgICAgICBzZWFyY2hhYmxlOiB0cnVlICAvLyBUaGlzIGNvbHVtbiBpcyBzZWFyY2hhYmxlXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAvLyBVc2UgTERBUFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgb3JkZXJhYmxlOiBmYWxzZSwgIC8vIFRoaXMgY29sdW1uIGlzIG5vdCBvcmRlcmFibGVcbiAgICAgICAgICAgICAgICAgICAgc2VhcmNoYWJsZTogZmFsc2UgIC8vIFRoaXMgY29sdW1uIGlzIG5vdCBzZWFyY2hhYmxlXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAvLyBMb2dpblxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgb3JkZXJhYmxlOiB0cnVlLCAgLy8gVGhpcyBjb2x1bW4gaXMgb3JkZXJhYmxlXG4gICAgICAgICAgICAgICAgICAgIHNlYXJjaGFibGU6IHRydWUgIC8vIFRoaXMgY29sdW1uIGlzIHNlYXJjaGFibGVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIC8vIFBhc3N3b3JkXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBvcmRlcmFibGU6IGZhbHNlLCAgLy8gVGhpcyBjb2x1bW4gaXMgbm90IG9yZGVyYWJsZVxuICAgICAgICAgICAgICAgICAgICBzZWFyY2hhYmxlOiBmYWxzZSAgLy8gVGhpcyBjb2x1bW4gaXMgbm90IHNlYXJjaGFibGVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIC8vIEFjY2VzcyBncm91cFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgb3JkZXJhYmxlOiB0cnVlLCAgLy8gVGhpcyBjb2x1bW4gaXMgb3JkZXJhYmxlXG4gICAgICAgICAgICAgICAgICAgIHNlYXJjaGFibGU6IHRydWUgIC8vIFRoaXMgY29sdW1uIGlzIHNlYXJjaGFibGVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIG9yZGVyOiBbMCwgJ2FzYyddLFxuICAgICAgICAgICAgbGFuZ3VhZ2U6IFNlbWFudGljTG9jYWxpemF0aW9uLmRhdGFUYWJsZUxvY2FsaXNhdGlvbixcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBkcm9wZG93biBsaXN0IGZvciB1c2Vycy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2VsZWN0ZWQgLSBUaGUgc2VsZWN0ZWQgdmFsdWUuXG4gICAgICogQHJldHVybnMge0FycmF5fSAtIFRoZSBkcm9wZG93biBsaXN0LlxuICAgICAqL1xuICAgIG1ha2VEcm9wZG93bkxpc3Qoc2VsZWN0ZWQpIHtcbiAgICAgICAgY29uc3QgdmFsdWVzID0gW107XG4gICAgICAgICQoJyN1c2Vycy1ncm91cHMtbGlzdCBvcHRpb24nKS5lYWNoKChpbmRleCwgb2JqKSA9PiB7XG4gICAgICAgICAgICBpZiAoc2VsZWN0ZWQgPT09IG9iai50ZXh0IHx8IHNlbGVjdGVkID09PSBvYmoudmFsdWUpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IG9iai50ZXh0LFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogb2JqLnZhbHVlLFxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsdWVzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBvYmoudGV4dCxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG9iai52YWx1ZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB2YWx1ZXM7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEhhbmRsZXMgdGhlIGNoYW5nZSBvZiBncm91cCBpbiB0aGUgbGlzdC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgLSBUaGUgc2VsZWN0ZWQgdmFsdWUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgLSBUaGUgc2VsZWN0ZWQgdGV4dC5cbiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGNob2ljZSAtIFRoZSBkcm9wZG93biBlbGVtZW50LlxuICAgICAqL1xuICAgIGNoYW5nZUdyb3VwSW5MaXN0KHZhbHVlLCB0ZXh0LCAkY2hvaWNlKSB7XG4gICAgICAgIGNvbnN0IHJvd0lkID0gJCgkY2hvaWNlKS5jbG9zZXN0KCd0cicpLmF0dHIoJ2lkJyk7XG4gICAgICAgIE1vZHVsZVVzZXJzVUlVc2Vyc1RhYi5hZGRQcm9ncmVzc0ljb24ocm93SWQpO1xuICAgICAgICAkLmFwaSh7XG4gICAgICAgICAgICB1cmw6IGAke2dsb2JhbFJvb3RVcmx9bW9kdWxlLXVzZXJzLXUtaS91c2Vycy1jcmVkZW50aWFscy9jaGFuZ2UtdXNlci1ncm91cGAsXG4gICAgICAgICAgICBvbjogJ25vdycsXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICB1c2VyX2lkOiByb3dJZCxcbiAgICAgICAgICAgICAgICBncm91cF9pZDogdmFsdWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3VjY2Vzc1Rlc3QocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAvLyB0ZXN0IHdoZXRoZXIgYSBKU09OIHJlc3BvbnNlIGlzIHZhbGlkXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAgICAgJiYgT2JqZWN0LmtleXMocmVzcG9uc2UpLmxlbmd0aCA+IDBcbiAgICAgICAgICAgICAgICAgICAgJiYgcmVzcG9uc2Uuc3VjY2VzcyA9PT0gdHJ1ZTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvblN1Y2Nlc3MoKSB7XG4gICAgICAgICAgICAgICAgTW9kdWxlVXNlcnNVSVVzZXJzVGFiLnJlbW92ZVByb2dyZXNzSWNvbihyb3dJZCk7XG4gICAgICAgICAgICAgICAgJCgnLnVpLm1lc3NhZ2UuYWpheCcpLnJlbW92ZSgpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9uRXJyb3IocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UubWVzc2FnZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhyZXNwb25zZS5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgTW9kdWxlVXNlcnNVSVVzZXJzVGFiLnJlbW92ZVByb2dyZXNzSWNvbihyb3dJZCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25GYWlsdXJlKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLm1lc3NhZ2UgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcocmVzcG9uc2UubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIE1vZHVsZVVzZXJzVUlVc2Vyc1RhYi5yZW1vdmVQcm9ncmVzc0ljb24ocm93SWQpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEhhbmRsZXMgdGhlIGNoYW5nZSBvZiBMREFQIGNoZWNrYm94IGluIHRoZSBsaXN0LlxuICAgICAqL1xuICAgIGNoYW5nZUxkYXBJbkxpc3QoKSB7XG4gICAgICAgIGNvbnN0IHJvd0lkID0gJCh0aGlzKS5jbG9zZXN0KCd0cicpLmF0dHIoJ2lkJyk7XG4gICAgICAgIE1vZHVsZVVzZXJzVUlVc2Vyc1RhYi5hZGRQcm9ncmVzc0ljb24ocm93SWQpO1xuICAgICAgICAkLmFwaSh7XG4gICAgICAgICAgICB1cmw6IGAke2dsb2JhbFJvb3RVcmx9bW9kdWxlLXVzZXJzLXUtaS91c2Vycy1jcmVkZW50aWFscy9jaGFuZ2UtdXNlci11c2UtbGRhcGAsXG4gICAgICAgICAgICBvbjogJ25vdycsXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICB1c2VyX2lkOiByb3dJZCxcbiAgICAgICAgICAgICAgICB1c2VMZGFwOiAkKHRoaXMpLnBhcmVudCgnLmNoZWNrYm94JykuY2hlY2tib3goJ2lzIGNoZWNrZWQnKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzdWNjZXNzVGVzdChyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIC8vIHRlc3Qgd2hldGhlciBhIEpTT04gcmVzcG9uc2UgaXMgdmFsaWRcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICAgICAmJiBPYmplY3Qua2V5cyhyZXNwb25zZSkubGVuZ3RoID4gMFxuICAgICAgICAgICAgICAgICAgICAmJiByZXNwb25zZS5zdWNjZXNzID09PSB0cnVlO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9uU3VjY2VzcygpIHtcbiAgICAgICAgICAgICAgICBNb2R1bGVVc2Vyc1VJVXNlcnNUYWIucmVtb3ZlUHJvZ3Jlc3NJY29uKHJvd0lkKTtcbiAgICAgICAgICAgICAgICBpZiAoJChgdHIjJHtyb3dJZH0gLnVzZXItdXNlLWxkYXAtY2hlY2tib3hgKS5jaGVja2JveCgnaXMgY2hlY2tlZCcpKXtcbiAgICAgICAgICAgICAgICAgICAgJChgdHIjJHtyb3dJZH0gdGQucGFzc3dvcmRgKS5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgICQoYHRyIyR7cm93SWR9IHRkLmxvZ2luYCkuYXR0cignY29sc3BhbicsMik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgJChgdHIjJHtyb3dJZH0gdGQucGFzc3dvcmRgKS5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgICQoYHRyIyR7cm93SWR9IHRkLmxvZ2luYCkuYXR0cignY29sc3BhbicsMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICQoJy51aS5tZXNzYWdlLmFqYXgnKS5yZW1vdmUoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvbkVycm9yKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLm1lc3NhZ2UgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcocmVzcG9uc2UubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIE1vZHVsZVVzZXJzVUlVc2Vyc1RhYi5yZW1vdmVQcm9ncmVzc0ljb24ocm93SWQpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9uRmFpbHVyZShyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5tZXNzYWdlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKHJlc3BvbnNlLm1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBNb2R1bGVVc2Vyc1VJVXNlcnNUYWIucmVtb3ZlUHJvZ3Jlc3NJY29uKHJvd0lkKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDaGFuZ2VzIHRoZSBsb2dpbiBhbmQgcGFzc3dvcmQgaW4gdGhlIGxpc3QuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHJvd0lkIC0gVGhlIElEIG9mIHRoZSByb3cuXG4gICAgICovXG4gICAgY2hhbmdlTG9naW5QYXNzd29yZEluTGlzdChyb3dJZCkge1xuICAgICAgICBjb25zdCBsb2dpbiA9ICQoYCMke3Jvd0lkfSBpbnB1dC51c2VyLWxvZ2luLWlucHV0YCkudmFsKCk7XG4gICAgICAgIGNvbnN0IHBhc3N3b3JkID0gJChgIyR7cm93SWR9IGlucHV0LnVzZXItcGFzc3dvcmQtaW5wdXRgKS52YWwoKTtcblxuICAgICAgICBNb2R1bGVVc2Vyc1VJVXNlcnNUYWIuYWRkUHJvZ3Jlc3NJY29uKHJvd0lkKTtcblxuICAgICAgICAkLmFwaSh7XG4gICAgICAgICAgICB1cmw6IGAke2dsb2JhbFJvb3RVcmx9bW9kdWxlLXVzZXJzLXUtaS91c2Vycy1jcmVkZW50aWFscy9jaGFuZ2UtdXNlci1jcmVkZW50aWFsc2AsXG4gICAgICAgICAgICBvbjogJ25vdycsXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICB1c2VyX2lkOiByb3dJZCxcbiAgICAgICAgICAgICAgICBsb2dpbjogbG9naW4sXG4gICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHBhc3N3b3JkLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHN1Y2Nlc3NUZXN0KHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgLy8gdGVzdCB3aGV0aGVyIGEgSlNPTiByZXNwb25zZSBpcyB2YWxpZFxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZSAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgICAgICYmIE9iamVjdC5rZXlzKHJlc3BvbnNlKS5sZW5ndGggPiAwXG4gICAgICAgICAgICAgICAgICAgICYmIHJlc3BvbnNlLnN1Y2Nlc3MgPT09IHRydWU7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25TdWNjZXNzKCkge1xuICAgICAgICAgICAgICAgIE1vZHVsZVVzZXJzVUlVc2Vyc1RhYi5yZW1vdmVQcm9ncmVzc0ljb24ocm93SWQpO1xuICAgICAgICAgICAgICAgICQoYHRyIyR7cm93SWR9IC5jaGFuZ2VkLWZpZWxkIGlucHV0YCkuYXR0cigncmVhZG9ubHknLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAkKGB0ciMke3Jvd0lkfSBkaXYuY2hhbmdlZC1maWVsZGApLnJlbW92ZUNsYXNzKCdjaGFuZ2VkLWZpZWxkIGxvYWRpbmcnKS5hZGRDbGFzcygndHJhbnNwYXJlbnQnKTtcbiAgICAgICAgICAgICAgICAkKCcudWkubWVzc2FnZS5hamF4JykucmVtb3ZlKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25FcnJvcihyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5tZXNzYWdlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKHJlc3BvbnNlLm1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBNb2R1bGVVc2Vyc1VJVXNlcnNUYWIucmVtb3ZlUHJvZ3Jlc3NJY29uKHJvd0lkKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvbkZhaWx1cmUocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UubWVzc2FnZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhyZXNwb25zZS5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgTW9kdWxlVXNlcnNVSVVzZXJzVGFiLnJlbW92ZVByb2dyZXNzSWNvbihyb3dJZCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIEFkZHMgc2F2ZSBpY29uIGZyb20gdGhlIHJvd1xuICAgICAqL1xuICAgIGFkZFByb2dyZXNzSWNvbihyb3dJZCl7XG4gICAgICAgICQoYHRyIyR7cm93SWR9IC5jaGFuZ2VkLWZpZWxkYCkuZmluZCgnLnVpLnNwaW5uZXIubG9hZGluZy5pY29uJykuc2hvdygpO1xuICAgIH0sXG4gICAgLyoqXG4gICAgICogUmVtb3ZlcyBzYXZlIGljb24gZnJvbSB0aGUgcm93XG4gICAgICovXG4gICAgcmVtb3ZlUHJvZ3Jlc3NJY29uKHJvd0lkKSB7XG4gICAgICAgICQoYHRyIyR7cm93SWR9IC5jaGFuZ2VkLWZpZWxkYCkuZmluZCgnLnVpLnNwaW5uZXIubG9hZGluZy5pY29uJykuaGlkZSgpO1xuICAgICAgICAkKGB0ciMke3Jvd0lkfSAuY2hhbmdlZC1maWVsZGApLmNsb3Nlc3QoJ2RpdicpLnNlYXJjaCgnaGlkZSByZXN1bHRzJykuc2VhcmNoKCdkZXN0cm95Jyk7XG4gICAgfSxcbiAgICBjYWxjdWxhdGVQYWdlTGVuZ3RoKCkge1xuICAgICAgICAvLyBDYWxjdWxhdGUgcm93IGhlaWdodFxuICAgICAgICBsZXQgcm93SGVpZ2h0ID0gTW9kdWxlVXNlcnNVSVVzZXJzVGFiLiR1c2Vyc1RhYmxlLmZpbmQoJ3RyJykuZmlyc3QoKS5vdXRlckhlaWdodCgpO1xuICAgICAgICAvLyBDYWxjdWxhdGUgd2luZG93IGhlaWdodCBhbmQgYXZhaWxhYmxlIHNwYWNlIGZvciB0YWJsZVxuICAgICAgICBjb25zdCB3aW5kb3dIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7XG4gICAgICAgIGNvbnN0IGhlYWRlckZvb3RlckhlaWdodCA9IDQwMDsgLy8gRXN0aW1hdGUgaGVpZ2h0IGZvciBoZWFkZXIsIGZvb3RlciwgYW5kIG90aGVyIGVsZW1lbnRzXG5cbiAgICAgICAgLy8gQ2FsY3VsYXRlIG5ldyBwYWdlIGxlbmd0aFxuICAgICAgICByZXR1cm4gTWF0aC5tYXgoTWF0aC5mbG9vcigod2luZG93SGVpZ2h0IC0gaGVhZGVyRm9vdGVySGVpZ2h0KSAvIHJvd0hlaWdodCksIDEwKTtcbiAgICB9LFxufTtcblxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuICAgIE1vZHVsZVVzZXJzVUlVc2Vyc1RhYi5pbml0aWFsaXplKCk7XG59KTtcblxuIl19